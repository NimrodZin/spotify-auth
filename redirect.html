<!DOCTYPE html>
<html>
<head>
    <title>Spotify Auth (PKCE)</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 40px; background: #121212; color: #fff; }
        .token-box { background: #282828; padding: 20px; border-radius: 8px; word-break: break-all; margin: 20px 0; }
        .success { color: #1DB954; }
        .error { color: #ff6b6b; }
        button { background: #1DB954; color: #000; border: none; padding: 12px 24px; border-radius: 24px; cursor: pointer; font-weight: bold; margin: 5px; }
        a { color: #1DB954; }
    </style>
</head>
<body>
    <h1>üéµ Spotify Auth</h1>
    <div id="result">Loading...</div>
    
    <script>
        const CLIENT_ID = '977213e55b904f67bfbe97bf8533b3df';
        const REDIRECT_URI = 'https://nimrodzin.github.io/spotify-auth/redirect.html';
        const SCOPES = 'user-read-playback-state user-modify-playback-state user-read-recently-played playlist-read-private user-read-currently-playing';

        // Generate random string for PKCE
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], '');
        }

        // SHA-256 hash
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        // Base64 URL encode
        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // Generate code challenge from verifier
        async function generateCodeChallenge(verifier) {
            const hashed = await sha256(verifier);
            return base64urlencode(hashed);
        }

        // Start authorization
        async function authorize() {
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store verifier for later
            localStorage.setItem('code_verifier', codeVerifier);
            
            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                response_type: 'code',
                redirect_uri: REDIRECT_URI,
                scope: SCOPES,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            
            window.location.href = `https://accounts.spotify.com/authorize?${params}`;
        }

        // Exchange code for token
        async function getToken(code) {
            const codeVerifier = localStorage.getItem('code_verifier');
            
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: CLIENT_ID,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier
                })
            });
            
            return response.json();
        }

        // Main logic
        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                document.getElementById('result').innerHTML = `
                    <p class="error">‚ùå Error: ${error}</p>
                    <button onclick="authorize()">Try Again</button>
                `;
                return;
            }
            
            if (code) {
                document.getElementById('result').innerHTML = '<p>Exchanging code for token...</p>';
                try {
                    const data = await getToken(code);
                    if (data.access_token) {
                        document.getElementById('result').innerHTML = `
                            <p class="success">‚úÖ Token received!</p>
                            <div class="token-box"><code>${data.access_token}</code></div>
                            <p>Copy this token and paste it into ChatGPT/SpotifyGPT.</p>
                            <button onclick="navigator.clipboard.writeText('${data.access_token}').then(() => this.textContent = 'Copied!')">Copy Token</button>
                            <p style="margin-top: 20px; color: #888;">Token expires in ${Math.round(data.expires_in / 60)} minutes.</p>
                        `;
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        throw new Error(data.error_description || data.error || 'Unknown error');
                    }
                } catch (e) {
                    document.getElementById('result').innerHTML = `
                        <p class="error">‚ùå Failed to get token: ${e.message}</p>
                        <button onclick="authorize()">Try Again</button>
                    `;
                }
                return;
            }
            
            // No code, show authorize button
            document.getElementById('result').innerHTML = `
                <p>Click below to connect your Spotify account:</p>
                <button onclick="authorize()">Connect to Spotify</button>
            `;
        }

        main();
    </script>
</body>
</html>
